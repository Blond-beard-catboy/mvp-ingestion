# MVP Ingestion Service

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–∏—ë–º–∞ —Å–æ–±—ã—Ç–∏–π —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **API** (Flask): –ø—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π, –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **Worker** (Celery/RabbitMQ): –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω)
- **PostgreSQL/MySQL**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ö–ª–æ–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repo-url>
cd mvp-ingestion

# –°–æ–∑–¥–∞–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# –∏–ª–∏ venv\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ API
pip install -r api/requirements.txt

# –°–∫–æ–ø–∏—Ä—É–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cp .env.example .env

```

## Day 2: RabbitMQ Producer

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–î–ª—è —Ä–∞–±–æ—Ç—ã Day 2 —Ç—Ä–µ–±—É–µ—Ç—Å—è RabbitMQ.

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ RabbitMQ:

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install -y rabbitmq-server
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server

# –í–∫–ª—é—á–∏—Ç—å web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo rabbitmq-plugins enable rabbitmq_management
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –î–Ω—è 3

### –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. **‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `events` –≤ PostgreSQL**:
   - –ö–æ–ª–æ–Ω–∫–∞ `event_id` —Ç–∏–ø–∞ VARCHAR –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è payload
   - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ –∏ –∫–æ–ª–æ–Ω–∫–∞–º

2. **‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ SQL**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT (event_id) DO NOTHING`
   - –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ `event_id` –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è
   - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Å—Ç–∞–≤–∫–∏

3. **‚úÖ –°–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç PostgreSQL**:
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

4. **‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞**:
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
   - –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É
./scripts/apply_sql_postgres.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
python scripts/test_idempotency.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é
psql $POSTGRES_URL -c "SELECT COUNT(*) FROM events;"
```

## –î–µ–Ω—å 4 ‚Äî Worker v1: –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –≤–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ RabbitMQ, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏—Ö –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL.

### –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r worker/requirements.txt
```

## üê≥ Docker Compose (–î–µ–Ω—å 5)

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Docker Compose:

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./scripts/docker-compose-up.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
./scripts/check-docker-services.sh

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./scripts/docker-compose-down.sh
```

## üê≥ –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è (–î–µ–Ω—å 6)

### –ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö 5 —Å–µ—Ä–≤–∏—Å–æ–≤
./scripts/docker-full-up.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
docker-compose up --build -d
```

## –î–µ–Ω—å 7 ‚Äî MySQL Projection (Best-Effort)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ö–ª–∏–µ–Ω—Ç -> API -> RabbitMQ -> Worker -> PostgreSQL (source of truth) -> MySQL (best-effort projection)


### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

- **PostgreSQL** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (source of truth)
  - –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–≤—ã–º–∏
  - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `ON CONFLICT`
  - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

- **MySQL** ‚Äî –ø—Ä–æ–µ–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è (projection)
  - Best-effort —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ MySQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ—Ç—á–µ—Ç–æ–≤, –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
  - –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ (eventual consistency)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
POSTGRES_URL=postgresql://events_user:password@postgres:5432/events_db

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (—Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –±–µ–∑ MySQL)
MYSQL_URL=mysql://events_user:password@mysql:3306/events_projection
```
